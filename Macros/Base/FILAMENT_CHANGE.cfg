[gcode_macro M600]
gcode: 
	PAUSE COOLDOWN=0
	FILAMENT_UNLOAD

[gcode_macro FILAMENT_UNLOAD]
description: Unloads Filament from extruder
gcode: 
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set TEMP = params.TEMP|default(printcfg.print_default_extruder_temp)|int %}
	{% set DISTANCE = params.DISTANCE|default(printcfg.filament_unload_distance)|int %}
	SAVE_GCODE_STATE NAME=UNLOAD_state
	_LOW_TEMP_CHECK T={TEMP}
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	RESTORE_GCODE_STATE NAME=UNLOAD_state

[gcode_macro FILAMENT_LOAD]
description: Loads filament into the extruder
gcode: 
	
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set TEMP = params.TEMP|default(printcfg.print_default_extruder_temp)|int %}
	{% set DISTANCE = params.DISTANCE|default(printcfg.filament_load_distance)|int %}
	
	SAVE_GCODE_STATE NAME=LOAD_state
	
	_LOW_TEMP_CHECK T={TEMP}
	_TIP_SHAPING
	
	M117 Loading Filament
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	G92 E0
	
	RESTORE_GCODE_STATE NAME=LOAD_state

[gcode_macro PURGE]
description: Extrudes filament, used to clean out previous filament
gcode: 
	
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set TEMP = params.TEMP|default(printcfg.print_default_extruder_temp)|int %}
	{% set PURGE_AMOUNT = params.PURGE_AMOUNT|default(40)|float %}
	
	_LOW_TEMP_CHECK T={TEMP}
	SAVE_GCODE_STATE NAME=PURGE_state
	G91
	G1 E{PURGE_AMOUNT} F{ 3 * 60 }
	RESTORE_GCODE_STATE NAME=PURGE_state

[gcode_macro _TIP_SHAPING]
description: Filament tip shaping sequence
gcode: 
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set TEMP = params.TEMP|default(printcfg.print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state