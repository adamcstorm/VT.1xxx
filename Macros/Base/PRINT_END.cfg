[gcode_macro PRINT_END]
gcode: 
	
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set verbose = printcfg.verbose %}
	{% set disable_motors_in_end_print = printcfg.disable_motors_in_end_print %}
	{% set filter_active = printcfg.filter_active %}
    {% set print_started = printcfg.print_started %}
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = 2 if th.axis_maximum.z - th.position.z > 2 else 0 %}

    M400                           ; wait for buffer to clear
    
	PRINT_STATUS_MSG_STOP
	STATUS_COOLING
    {% if print_started %}
        G91                            ; relative positioning
        G92 E0                         ; zero the extruder
        G1 X{x_safe} Y{y_safe} Z{z_safe} E-2.0 F20000                 ; retract filament
        # G1 Z2 F3000                    ; lift nozzle a touch to avoid crashing into bed
        G90                            ; absolute positioning
        # G0 X{x_safe} Y{y_safe} Z{z_safe} F20000 ; move nozzle to remove stringing
        G91                            ; relative positioning
    {% endif %}
	
	PARK
    
    {% if print_started %}
        G1 E-18 F1200
    {% endif %}
	
	TURN_OFF_HEATERS
	TURN_OFF_FANS
	M400
	
	
	
	{% if filter_active %}
        {% set FILTER_TIME = params.FILTER_TIME|default(printcfg.filter_time)|int %}
        START_FILTER SPEED=1
        UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME*60}
	{% endif %}
	
	{% if disable_motors_in_end_print %}
        M84
	{% endif %}

    SET_GCODE_VARIABLE MACRO=_printcfg VARIABLE=print_started VALUE=0
	
	M117 Print complete
	STATUS_PART_READY
	UPDATE_DELAYED_GCODE ID=clear_display DURATION=600
	_SAVE_IF_SET

[gcode_macro TURN_OFF_FANS]
gcode: 
	M107
	# SET_FAN_SPEED FAN=aux_cooling SPEED=0