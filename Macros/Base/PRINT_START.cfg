[gcode_macro PRINT_WARMUP]
description: Perform initial homing and heating tasks
gcode:
    {% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(260) | float %}
    {% set BED_TEMP = params.BED_TEMP | default(115) | float %}
	{% set MATERIAL = params.MATERIAL|default(printcfg.print_default_material)|string %}

    # Homing, QGL, pre-warming print nozzle etc.
    M104 S{EXTRUDER_TEMP - 50}      # set extruder temperature to 75%
    M140 S{BED_TEMP}                # set bed temperature
    SET_DOCKABLE_PROBE AUTO_ATTACH_DETACH=0
    G28                             # home printer
    PARK_CENTER

    # wait for the print bed to reach thermal equilibrium
    {% if MATERIAL == "ABS" %}
        UPDATE_DELAYED_GCODE ID=clear_display DURATION=0
        PRINT_STATUS_MSG_STOP
    	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION=0
        # STATUS_CHAMBER_HEATING
    	# HEAT_SOAK HEATER='heater_bed' TARGET={BED_TEMP} CANCEL='CANCEL_PRINT' SOAKER='temperature_sensor chamber' SOAK_TEMP=50 RATE=0.1 TEMP_SMOOTH=6 RATE_SMOOTH=30 TIMEOUT=90 HEATING_REPORT_INTERVAL=10 SOAKING_REPORT_INTERVAL=30
    	HEAT_SOAK HEATER='heater_bed' TARGET={BED_TEMP} CANCEL='CANCEL_PRINT' SOAKER='temperature_sensor chamber' SOAK_TEMP=45 TEMP_SMOOTH=6 RATE_SMOOTH=30 TIMEOUT=90 HEATING_REPORT_INTERVAL=10 SOAKING_REPORT_INTERVAL=30 EXTRUDER_TEMP={EXTRUDER_TEMP - 50}
    {% endif %}
    
[gcode_macro PRINT_START]
gcode: 
	
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set verbose = printcfg.verbose %}
	{% set filter_enabled = printcfg.filter_enabled%}
	
	
	{% set BED = params.BED|default(printcfg.print_default_bed_temp)|float %}
	{% set BED_TEMP = params.BED_TEMP|default(0)|float %}
	{% set EXTRUDER = params.EXTRUDER|default(printcfg.print_default_extruder_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(0)|float %}
	{% set MATERIAL = params.MATERIAL|default(printcfg.print_default_material)|string %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if (EXTRUDER_TEMP > 0) %}
    	{% set EXTRUDER = EXTRUDER_TEMP %}
	{% endif %}
	
	{% if (BED_TEMP > 0) %}
    	{% set BED = BED_TEMP %}
	{% endif %}

	UPDATE_DELAYED_GCODE ID=clear_display DURATION=0
	SET_GCODE_VARIABLE MACRO=_printcfg VARIABLE=filter_active VALUE=0
	
	
	M117 Initializing...
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION=0
	# SET_FAN_SPEED FAN=aux_cooling SPEED=0
	M220 S100
	M221 S100
	M107
	G92 E0
	
	G90
	M83
	M117 Heating bed
	# STATUS_HEATING
	M190 S{BED}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER - 50}
	
	M117 Homing
    STATUS_CALIBRATING_Z
    Z_TILT_ADJUST
    STATUS_LEVELING
    G28 Z
    STATUS_MESHING
    BED_MESH_CALIBRATE ADAPTIVE=1
    DETACH_PROBE
    SET_DOCKABLE_PROBE AUTO_ATTACH_DETACH=1
	G90
	
	
	M117 Heating extruder
	# STATUS_HEATING
	M104 S{EXTRUDER}
	
	
	
	RESPOND MSG="Material = {MATERIAL}"
	{% if MATERIAL == "PLA" %}
    	SET_PRESSURE_ADVANCE ADVANCE={printcfg.pressure_advance_pla}
    	SET_RETRACTION RETRACT_LENGTH={printcfg.retract_length_pla} RETRACT_SPEED={printcfg.retract_speed_pla} UNRETRACT_EXTRA_LENGTH={printcfg.unretract_extra_length_pla} UNRETRACT_SPEED={printcfg.unretract_speed_pla}
	
	{% elif MATERIAL == "PETG" %}
    	SET_PRESSURE_ADVANCE ADVANCE={printcfg.pressure_advance_petg}
    	SET_RETRACTION RETRACT_LENGTH={printcfg.retract_length_petg} RETRACT_SPEED={printcfg.retract_speed_petg} UNRETRACT_EXTRA_LENGTH={printcfg.unretract_extra_length_petg} UNRETRACT_SPEED={printcfg.unretract_speed_petg}
	
	{% elif MATERIAL == "ABS" %}
    	SET_PRESSURE_ADVANCE ADVANCE={printcfg.pressure_advance_abs}
    	SET_RETRACTION RETRACT_LENGTH={printcfg.retract_length_abs} RETRACT_SPEED={printcfg.retract_speed_abs} UNRETRACT_EXTRA_LENGTH={printcfg.unretract_extra_length_abs} UNRETRACT_SPEED={printcfg.unretract_speed_abs}
	
    	{% if filter_enabled %}
        	SET_GCODE_VARIABLE MACRO=_printcfg VARIABLE=filter_active VALUE=1
        	START_FILTER SPEED=1
    	{% endif %}
	{% endif %}
	
	
	
	
	STATUS_STANDBY
	Smart_Park
	M109 S{EXTRUDER}
	
	LINE_PURGE
	
	{% if verbose %}
    	RESPOND MSG="Printing!"
	{% endif %}
	M117 Printing
	STATUS_PRINTING
	PRINT_STATUS_MSG_UPDATE
    # STOP_HEAT_SOAK
    SET_GCODE_VARIABLE MACRO=_printcfg VARIABLE=print_started VALUE=1

[gcode_macro PRIME_EXTRUDER]
gcode: 
	G90
	G0 X1.25 Y1.25 F18000
	G0 Z0.3 F5000
	M83
	G92 E0.0
	G1 E13 F300
	G1 X85 E10 F2500
	
	G92 E0.0
	G1 E-0.2 F1500
	G92 E0.0
	G1 X110 F40000
	G1 Z3 F5000;
	G92 E0